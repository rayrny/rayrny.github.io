---
layout: posts
title: "ğŸš€ [React] React16ê³¼ Suspense, ì§ì ‘ êµ¬í˜„í•´ë³´ê¸° 1"
categories:
  - React
last_modified_at: 2023-01-07
author_profile: true
tags:
  - suspense
  - react
toc: true
toc_sticky: true
sidebar:
  title: Posts
  nav: "sidebar-contents"
---

## ê°œìš”

### SuspenseëŠ” ì–´ë–»ê²Œ ë™ì‘í• ê¹Œ?

`ErrorBoundary`ê°€ `error`ë¥¼ ê°ì§€í•´ì„œ throw í•˜ëŠ” ê²ƒ ì²˜ëŸ¼, `Suspense`ëŠ” `Promise`ë¥¼ ê°ì§€í•œë‹¤.


### Suspense ëŠ” ì™œ ì‚¬ìš©í•˜ë©´ ì¢‹ì„ê¹Œ?

ë¬´ì—‡ê³¼ ì–´ë–»ê²Œë¥¼ ë¶„ë¦¬í•  ìˆ˜ ìˆê³ , ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œëŠ” ë°ì´í„° í˜ì¹­ì— ê´€ë ¨ëœ ìƒíƒœ(ë¡œë”©, ì‹¤íŒ¨, ì„±ê³µ)ë¥¼ ê´€ë¦¬í•˜ê±°ë‚˜ ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ëœë‹¤.

â†’ ì„ ì–¸ì  í”„ë¡œê·¸ë˜ë°(ì–´ë–¤ê±¸ ê°€ì§€ê³  ë¬´ì—‡ì„ í• ì§€)ì´ ê°€ëŠ¥í•´ì§

### ëŒ€ìˆ˜ì  íš¨ê³¼ì™€ Suspense

1. ëŒ€ìˆ˜ì  íš¨ê³¼ëŠ” ê°ì‹¸ê³  ìˆëŠ” í•¨ìˆ˜ì˜ ë¡œì§ì´ ê°ì‹¸ì§„(ë‚´í¬í•˜ëŠ”) í•¨ìˆ˜ì˜ ì—­í• ì„ ë¶„ë¦¬í•  ë•Œ ì‹¤í˜„ëœë‹¤.
2. Reactì˜ SuspenseëŠ” ìì‹ ì»´í¬ë„ŒíŠ¸ë¥¼ ê°ì‹¸ëŠ” ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì—ê²Œ ë¡œë”© UI í‘œì‹œë¼ëŠ” ì—­í• ì„ ë¶„ë¦¬í•˜ê³  ìˆë‹¤.
3. Reactì˜ Suspenseì˜ ì°½ì•ˆ ì›ë¦¬ëŠ” ëŒ€ìˆ˜ì  íš¨ê³¼ì´ë‹¤.



## ë³¸ë¡ 

> React 18 ì´ì „ì˜ SuspenseëŠ” Data Fetchingì„ ìœ„í•œ Pending Handlerê°€ ì•„ë‹ˆë¼, ê¸°ì¡´ì˜ ì›Œí„°í´ ë°©ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ìˆëŠ” Renderë°©ì‹ì„ ê°œì„ í•´ì£¼ëŠ” ì—­í• ì´ë‹¤. 
> [https://sangminnn.tistory.com/76](https://sangminnn.tistory.com/76)
> 

### í•„ìš”í•œ êµ¬ì¡°

- promiseë¥¼ ê°ì§€í•´ì„œ ì»´í¬ë„ŒíŠ¸ë¥¼ suspended ìƒíƒœë¡œ ë§Œë“¤ì–´ ì¤„ ì¥ì¹˜ (data fetchingì„ ìœ„í•œ suspense)
    - `react-query`ì˜ suspense ì˜µì…˜ ì‚¬ìš©í–ˆì„ ë•Œì™€ ê°™ì€ êµ¬ì¡°ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ë³´ë ¤ê³  í•¨
    - ì´ë¯¸ì§€, dynamic import, fetchingì„ ëª¨ë‘ ì§€ì›
    - ì´í›„ api í˜¸ì¶œí•  ë•Œ ìœ„ì˜ ì¥ì¹˜ë¥¼ í†µí•´ í˜¸ì¶œí•´ì•¼ í•¨
- ì—ëŸ¬ ë°”ìš´ë”ë¦¬

â†’ @toss/async-boundary


ì°¸ê³  ë¸”ë¡œê·¸
* [https://jbee.io/react/error-declarative-handling-1/](https://jbee.io/react/error-declarative-handling-1/)
* [https://maxkim-j.github.io/posts/suspense-argibraic-effect](https://maxkim-j.github.io/posts/suspense-argibraic-effect)
* [https://velog.io/@imnotmoon/React-Suspense-ErrorBoundary-ì§ì ‘-ë§Œë“¤ê¸°](https://velog.io/@imnotmoon/React-Suspense-ErrorBoundary-%EC%A7%81%EC%A0%91-%EB%A7%8C%EB%93%A4%EA%B8%B0)

### **WrappedPromise(createPromiseResource) â†’ useFetch í›…ìœ¼ë¡œ ê³ ë„í™”**

```jsx
// suspenseì™€ í•¨ê»˜ ì‚¬ìš©í•˜ê¸° ìœ„í•´, ìì‹ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë°ì´í„° íŒ¨ì¹˜ ì‹œ ì´ ìœ í‹¸ ì‚¬ìš©
const createPromiseResource = (promise) => {
  let status = "pending";
  let result = null;

  const suspender = promise.then(
    (res) => {
      status = "fulfilled";
      result = res;
    },
    (err) => {
      status = "rejected";
      result = err;
    }
  );

  return {
    read() {
      switch (status) {
        case "pending":
          throw suspender;
        case "fulfilled":
          throw result;
        case "rejected":
          throw result;
        default:
          break;
      }
    },
  };
};

export default createPromiseResource;
```

```jsx
// ë¹„ë™ê¸° í˜¸ì¶œì„ í•˜ëŠ” ì»´í¬ë„ŒíŠ¸
import React, { useState, useEffect } from "react";

import { getUser } from "../apis";
import createPromiseResource from "../utils/createPromiseResource";

// ì—¬ê¸°ì„œ react-queryë‚˜ axiosë¡œ ë¹„ë™ê¸° fetch ì‘ì—… ì§„í–‰
// https://6391fa92b750c8d178d35d54.mockapi.io/api/profile/:id

const useResource = (id) => createPromiseResource(getUser(id)).read();

function UserItem({ id }) {
  const data = useResource(id);

  return <div>ì´ë¦„: {data.name}</div>;
}

export default UserItem;
```


### **ErrorBoundary**

```jsx
import React from "react";

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props); // propsë¡œ errorFallbackì„ ë°›ì„ ìˆ˜ ìˆìŒ
    this.state = {
      error: null,
    };
  }

  static getDerivedStateFromError(error) {
    console.log("getDerivedStateFromError");
    return { error };
  }

  componentDidCatch(err, info) {
    console.log("componentDidCatch", err, info);
    this.setState({
      error: err,
    });
  }

  render() {
    if (this.state.error) {
      return this.props.fallback ?? <h3>ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ :(</h3>;
    }
    return this.props.children;
  }
}

export default ErrorBoundary;
```

### 1ì°¨ ì‹œë„ ì½”ë“œì—ì„œ ë¬¸ì œì 
1. ë¹„ë™ê¸° í˜¸ì¶œì„ í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì—ì„œ `createPromiseResource` ë¥¼ ì‚¬ìš©í•  ë•Œ,
    * ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ë¡œ `getUser(id)`ë°›ê³  ìˆì—ˆê¸° ë•Œë¬¸ì— ê³„ì†í•´ì„œ ì‹¤í–‰ë˜ê³  ìˆì—ˆìŒ
        
        <iframe width="1044" height="587" src="https://user-images.githubusercontent.com/48341341/211147298-e4697b46-49a0-4d8c-8a96-7141af4e9cfa.mov" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

2. ë¶€ë„ëŸ½ê²Œë„ ê·¼ë³¸ì ìœ¼ë¡œ `.then().catch()`ë¬¸ì„ ì˜ëª» ì“°ê³  ìˆì—ˆìŒ(ë¬¸ë²• ì—ëŸ¬)
3. 1ì˜ ë¬¸ì œì ì„ í•´ê²°í•˜ë©´ì„œ ê·¼ë³¸ì ì¸ ë¬¸ì œë¥¼ ë°œê²¬í–ˆëŠ”ë°, `createPromiseResource` ìœ í‹¸ì„ ë¦¬ì•¡íŠ¸ ë°–ì— ë¹¼ë‘ê¸´ í–ˆì§€ë§Œ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ë¡œ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì— (`.read()`) ë¦¬ì•¡íŠ¸ ë‚´ë¶€ì—ì„œ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ìƒˆë¡œ ìƒì„±ë˜ê³  ìˆì—ˆìŒ
    
    â†’ statusê°€ pendingì¸ ìƒíƒœê°€ ê³„ì† ìƒì„± (ì›ë˜ëŠ” í•œ ë²ˆë§Œ ë§Œë“¤ì–´ì§€ê³  ê·¸ statusì˜ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ ë˜ì–´ì•¼ í•¨)

### í•´ê²° ë°©ë²•

1. ì•„ë˜ì™€ ê°™ì´ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ë¡œ ì‚¬ìš©í•œ ë¶€ë¶„ì„ ìˆ˜ì •í•¨ 
    
    ```jsx
    
    // ë¹„ë™ê¸° í˜¸ì¶œì„ í•˜ëŠ” ì»´í¬ë„ŒíŠ¸
    const useResource = (id) => createPromiseResource(() => getUser(id));
    
    function UserItem({ id }) {
      const { data } = useResource(id).read(); // read()ëŠ” ìœ„ì— ìˆìœ¼ë‚˜ ì—¬ê¸° ìˆìœ¼ë‚˜ ì°¨ì´ ì—†ìŒ
    
      return <div>ì´ë¦„: {data.name}</div>;
    }
    
    export default UserItem;
    ```
    
    ì´ì— ë”°ë¼ suspenderì—ì„œ promiseë¥¼ ì‹¤í–‰í•œ ë’¤ì— .then í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½
    
    ```jsx
    // createPromiseResource
    const suspender = promise().then(...) // ê¸°ì¡´: promise.then(...)
    ```

2. ë¬¸ë²• ìˆ˜ì •
    
    ```jsx
    // createPromiseResource
    let suspender = promise()
        .then((res) => {
          status = "fulfilled";
          result = res;
        })
        .catch((err) => {
          status = "rejected";
          result = err;
        });
    ```

3. ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë¦¬ì•¡íŠ¸ ìƒëª…ì£¼ê¸°ë¥¼ ë²—ì–´ë‚œ ì „ì—­ ìƒíƒœ ê´€ë¦¬ê°€ í•„ìš”í–ˆë‹¤. (useRef ë“±ë„ ì†Œìš© ì—†ìŒ - suspenseì— ê°–íŒ ìƒíƒœì—ì„œëŠ” ì• ì´ˆì— ë Œë”ë§ ì¡°ì°¨ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹„êµí•  ëŒ€ìƒì´ ì—†ìŒ)
    1. store ì „ì—­ ê°ì²´ ì¶”ê°€
    2. ìš”ì²­ì„ í•  ë•Œë§ˆë‹¤ ì–´ë–¤ ìš”ì²­ì— ëŒ€í•œ ìƒíƒœì¸ì§€ ì‹ë³„í•˜ê¸° ìœ„í•´ key ì¶”ê°€ (feat. react-query)
    
    ```jsx
    const store = {};
    
    const createPromiseResource = (key, promise) => {
      if (!store[key]) {
        store[key] = {
          status: "pending",
          result: null,
        };
      }
    
      let suspender = promise()
        .then((res) => {
          store[key].status = "fulfilled";
          store[key].result = res;
        })
        .catch((err) => {
          store[key].status = "rejected";
          store[key].result = err;
        });
    
      return {
        read() {
          switch (store[key].status) {
            case "pending":
              throw suspender;
            case "rejected":
              throw store[key].result;
            default:
              return store[key].result;
          }
        },
      };
    };
    
    export default createPromiseResource;
    ```



ë¦¬íŒ©í† ë§ í•˜ëŠ” ê³¼ì •ê³¼ ì–»ê²Œ ëœ ê²°ê³¼ë¬¼ì— ëŒ€í•œ ì •ë¦¬ëŠ” ë‹¤ìŒ í¬ìŠ¤íŒ…ì—ì„œ..!