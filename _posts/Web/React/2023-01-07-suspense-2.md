---
layout: posts
title: "ğŸš€ [React] React16ê³¼ Suspense, ì§ì ‘ êµ¬í˜„í•´ë³´ê¸° 2"
categories:
  - React
last_modified_at: 2023-01-01
author_profile: true
tags:
  - suspense
  - react
toc: true
toc_sticky: true
sidebar:
  title: Posts
  nav: "sidebar-contents"
---


### ë¦¬íŒ©í† ë§

ì´ì œ ë‚´ë¶€ êµ¬í˜„ì€ ì™„ë£Œí–ˆìœ¼ë‹ˆ, ì´ ìœ í‹¸ì„ ì¢€ ë” ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í›…ìœ¼ë¡œ ë§Œë“¤ì–´ë³´ì.

- Promiseì˜ statusì™€ result(error), suspenderë¥¼ í•˜ë‚˜ë¡œ ë¬¶ì–´ map ìë£Œêµ¬ì¡°ì— ì €ì¥
    - createCustomPromise ë¥¼ í†µí•´ ìœ„ ì •ë³´ë“¤ì„ êµ¬ì¡°í™”
- useFetch ì—ì„œëŠ” customPromiseì˜ ìƒíƒœì— ë”°ë¼ suspenderë¥¼ ë˜ì§ˆì§€(pending), ì—ëŸ¬ë¥¼ ë˜ì§ˆì§€(rejected), ê²°ê³¼ë¥¼ ë°˜í™˜í• ì§€(fulfilled) ê²°ì •í•œë‹¤.
    - ì´ ë•Œ suspenderë¥¼ ë˜ì§€ê²Œ ë˜ë©´ pendingì´ Suspenseì— ê°–íˆê²Œ ë˜ëŠ”ë°, ì´ë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•´ statusì˜ ì´ˆê¹ƒê°’ì„ nullë¡œ ì§€ì •í–ˆë‹¤.
    - ì´ë¥¼ í†µí•´ ì²˜ìŒì—ëŠ” suspenderë¥¼ ë˜ì§€ê³ , ì´í›„ì— statusê°€ pendingì´ ê°ì§€ë˜ëŠ” ê²½ìš°ëŠ” Suspenseê°€ pendingì„ ì œëŒ€ë¡œ ê°€ë‘ì§€ ëª»í•œ ìƒí™©ìœ¼ë¡œ íŒë‹¨í•˜ê³  ì—ëŸ¬ë¥¼ ë˜ì§„ë‹¤.

```jsx
const PROMISE_STATUS = {
  PENDING: "pending",
  SUCCESS: "fulfilled",
  FAIL: "rejected",
};

const promiseStoreMap = new Map();

const createCustomPromise = (asyncFunction) => {
  const customPromise = {
    status: null,
    result: null,
    error: null,
  };

  const suspender = async () => {
    // ê¸°ì¡´ suspender ë¶€ë¶„
    try {
      customPromise.status = PROMISE_STATUS.PENDING;
      customPromise.result = await asyncFunction();
      customPromise.status = PROMISE_STATUS.SUCCESS;
    } catch (err) {
      customPromise.status = PROMISE_STATUS.FAIL;
      customPromise.error = err;
    }
  };

  customPromise.run = suspender;
  return customPromise;
};

function useFetch(key, asyncFunction) {
  if (!promiseStoreMap.has(key)) {
    promiseStoreMap.set(key, createCustomPromise(asyncFunction));
  }

  const customPromise = promiseStoreMap.get(key);
  if (customPromise.status === null) {
    throw customPromise.run(); // suspender
  } else if (customPromise.status === PROMISE_STATUS.FAIL) {
    throw customPromise.error;
  }

  if (customPromise.stauts === PROMISE_STATUS.PENDING) {
    // statusì˜ ì´ˆê¸° ìƒíƒœëŠ” nullì´ê³  ì´í›„ì— pendingìœ¼ë¡œ ë°”ë€ ë’¤, fulfilled í˜¹ì€ rejectedê°€ ëœë‹¤.
    // pendingì¼ ê²½ìš° suspenseì— ê°–íˆê²Œ ë  í…ë°, ì—¬ê¸°ì„œ ê°ì§€ë  ê²½ìš°ëŠ” suspenseì˜ ë™ì‘ì´ ì˜ëª»ëœ ê²ƒ
    throw new Error("Suspense Error");
  }

  return { data: customPromise.result };
}

export default useFetch;
```

### QueryKeyë¥¼ ê³ ë„í™” í•  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?

react-queryì™€ ê°™ì´ queryKeyë¥¼ ë°°ì—´ë¡œ ë„˜ê¸´ë‹¤ë˜ê°€, ìºì‹± ë“±ì„ êµ¬í˜„í•  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œì— ëŒ€í•œ ìƒê°ì´ ìŠ¤ì³ ì§€ë‚˜ê°”ë‹¤.

ìš°ì„  ì²« ë²ˆì§¸ë¡œ queryKeyë¥¼ ë°°ì—´ë¡œ ë„˜ê¸¸ ìˆ˜ ìˆë„ë¡ ë³€ê²½í–ˆë‹¤.

ì´ë¥¼ ìœ„í•´ì„œ `map.has()`ì™€ `map.get()`ì„ key ê°€ ë°°ì—´ì¼ ê²½ìš°ì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½ì´ í•„ìš”í–ˆë‹¤. lodashì˜ isEqualì„ í†µí•´ ë°°ì—´ì´ ê°™ì€ ë°°ì—´ì¸ì§€ ë¹„êµí•˜ê³  í•„ìš”í•œ ê°’ì„ ë°˜í™˜í•œë‹¤.

```jsx
const hasKey = (key) => {
  let isExist = false;
  promiseStoreMap.forEach((value, _key) => {
    if (_isEqual(_key, key)) {
      isExist = true;
    }
  });
  return isExist;
};

const getByKey = (key) => {
  let mapValue = null;
  promiseStoreMap.forEach((value, _key) => {
    if (_isEqual(_key, key)) {
      mapValue = value;
    }
  });
  return mapValue;
};
```

```jsx
function UserListAxios() {
  const ids = [1, 1, 3, 4, 5, 6];
  return (
    <div>
      <h3>ìœ ì € í”„ë¡œí•„ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.</h3>
      {ids.map((id) => {
        return (
          <div key={id}>
            <AsyncBoundary
              pendingFallback={<div>ë¡œë”©ì¤‘...</div>}
              rejectedFallback={(e) => <div>ì—ëŸ¬ ë°œìƒ!!!{e.message}</div>}
            >
              <UserItemAxios id={id} />
            </AsyncBoundary>
            <hr />
          </div>
        );
      })}
    </div>
  );
}

export default UserListAxios;
```

![susepense.mov](https://user-images.githubusercontent.com/48341341/215519425-7fcd7350-3cc9-4610-830e-9d6d91f3a9eb.mov)


ì´ ê²½ìš°ì— ë™ì¼í•œ ì¿¼ë¦¬ í‚¤ë¥¼ ë„˜ê²¨ë°›ì„ ê²½ìš° ì•„ë˜ í™”ë©´ê³¼ ê°™ì´ ì—ëŸ¬ê°€ ë°œìƒí•´ë²„ë¦¬ëŠ”ë°,
![user-error](https://user-images.githubusercontent.com/48341341/215519100-769fd9c8-a975-4731-8426-d5a6b39ceeae.png)

ìš°ë¦¬ëŠ” ë™ì¼í•œ ì¿¼ë¦¬ í‚¤ê°€ ë„˜ì–´ì™”ì„ ë•ŒëŠ” ì´ì „ì— ìºì‹±ëœ ê°’ì„ ë°˜í™˜í•˜ë„ë¡ ë³€ê²½í•´ì¤„ê²ƒì´ë‹¤.


### ì—ëŸ¬ëŠ” ì™œ ë°œìƒí• ê¹Œ?
useFetch í•˜ë‹¨ì— ì¶”ê°€í•œ ë°”ë¡œ ì•„ë˜ ë¶€ë¶„ì— ê±¸ë ¤ì„œ ì—ëŸ¬ë¥¼ throw í•˜ê²Œ ëœ ê²ƒì¸ë°, ë™ì¼í•œ queryKeyë¡œ í˜¸ì¶œí–ˆì„ ê²½ìš° ë‘ ë²ˆì§¸ëŠ” ë‹¹ì—°íˆ ì²« ë²ˆì§¸ì—ì„œ ë˜ì§„ suspenderê°€ ìˆê¸° ë•Œë¬¸ì— pending ìƒíƒœê°€ ëœë‹¤.

```jsx
  if (customPromise.stauts === PROMISE_STATUS.PENDING) {
    // statusì˜ ì´ˆê¸° ìƒíƒœëŠ” nullì´ê³  ì´í›„ì— pendingìœ¼ë¡œ ë°”ë€ ë’¤, fulfilled í˜¹ì€ rejectedê°€ ëœë‹¤.
    // pendingì¼ ê²½ìš° suspenseì— ê°–íˆê²Œ ë  í…ë°, ì—¬ê¸°ì„œ ê°ì§€ë  ê²½ìš°ëŠ” suspenseì˜ ë™ì‘ì´ ì˜ëª»ëœ ê²ƒ
    throw new Error("Suspense Error");
  }
```

ë”°ë¼ì„œ í•´ë‹¹ ì¡°ê±´ë¬¸ì— ë“¤ì–´ì™”ì„ ë•Œ ì´ë¯¸ ë˜ì ¸ì§„ suspenderê°€ ìˆë‹¤ë©´ ë°”ë¡œ ê·¸ suspenderë¥¼ ë˜‘ê°™ì´ ë˜ì§€ë©´ ëœë‹¤.

ì´ ë•Œ ì£¼ì˜í•´ì•¼ í•˜ëŠ” ë¶€ë¶„ì€ pendingì¼ ë•Œ throw í•˜ëŠ” suspenderëŠ” ì´ì „ì— ë˜ì§„ suspenderì—¬ì•¼ í•œë‹¤ëŠ” ì ì´ë‹¤. `throw customPromise.run()`ì„ í•´ë²„ë¦¬ë©´ ìƒˆë¡œìš´ proimseê°€ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— network íƒ­ì—ì„œ ë³´ë©´ ë¶ˆí•„ìš”í•˜ê²Œ ìš”ì²­ì´ í•œ ë²ˆ ë” ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![throw customPromise.run()](https://user-images.githubusercontent.com/48341341/215519618-e82fcd24-9f7b-4079-96b6-30303e3f677a.mov)


![throw customPromise.cache](https://user-images.githubusercontent.com/48341341/215519735-c8e17074-c4a3-4c9c-b6e8-35cbb76c98e9.mov)

ìˆ˜ì •í•œ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```jsx
if (customPromise.status === null) {
    // ê°™ì€ queryKey ê°’ìœ¼ë¡œ ë¶ˆë ¸ì„ ê²½ìš°, ê°™ì€ promiseë¥¼ ë°”ë¼ë³¼ ìˆ˜ ìˆë„ë¡ cacheì— ì‹¤í–‰í•œ suspender(.run())ë¥¼ ë‹´ì•„ì¤€ë‹¤.
    customPromise.cache = customPromise.run(); // ì¶”ê°€ëœ ë¶€ë¶„
    throw customPromise.run(); // suspender
  } else if (customPromise.status === PROMISE_STATUS.FAIL) {
    throw customPromise.error;
  }

  if (customPromise.status === PROMISE_STATUS.PENDING) {
    if (customPromise.cache) {
      // ìºì‹œëœ ê°’ì´ ìˆì„ ê²½ìš° í•´ë‹¹ suspenderë¥¼ ë‹¤ì‹œ ë˜ì§€ê³  ì´ì™¸ì˜ ê²½ìš°ì—ëŠ” ì—ëŸ¬ë¡œ íŒë‹¨
      throw customPromise.cache; // ì¶”ê°€ëœ ë¶€ë¶„
    }
    throw new Error("Suspense Error");
  }
```

ë‹¤ë¥¸ ìˆ˜ì • ì‚¬í•­ìœ¼ë¡œëŠ” ë°°ì—´ë¡œ ë°›ì€ queryKeyë¥¼ ê·¸ëŒ€ë¡œ map ì˜ key ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³  JSON.stringifyë¥¼ í•´ì„œ string íƒ€ì…ì˜ keyë¡œ ì“¸ ìˆ˜ ìˆê²Œ ë³€ê²½í–ˆë‹¤. (ë°°ì—´ì„ keyë¡œ ì“¸ ê²½ìš°, `set, get, has` ë“±ì—ì„œ ì›í•˜ëŠ”ëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•Šì•„ ë”°ë¡œ ë§Œë“¤ì–´ ì¤¬ì–´ì•¼ í–ˆìŒ)



ì™„ì„±ëœ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤!

```jsx
const PROMISE_STATUS = {
  PENDING: "pending",
  SUCCESS: "fulfilled",
  FAIL: "rejected",
};

const promiseStoreMap = new Map();
window.promiseMap = promiseStoreMap;

const createCustomPromise = (asyncFunction) => {
  const customPromise = {
    status: null,
    result: null,
    error: null,
    cache: null,
  };

  const suspender = async () => {
    // ê¸°ì¡´ suspender ë¶€ë¶„
    try {
      customPromise.status = PROMISE_STATUS.PENDING;
      customPromise.result = await asyncFunction();
      customPromise.status = PROMISE_STATUS.SUCCESS;
    } catch (err) {
      customPromise.status = PROMISE_STATUS.FAIL;
      customPromise.error = err;
    }
  };

  customPromise.run = suspender;
  return customPromise;
};

function useFetch(key, asyncFunction) {
  const parsedKey = JSON.stringify(key);
  if (!promiseStoreMap.has(parsedKey)) {
    promiseStoreMap.set(parsedKey, createCustomPromise(asyncFunction));
  }

  const customPromise = promiseStoreMap.get(parsedKey);

  if (customPromise.status === null) {
    // ê°™ì€ queryKey ê°’ìœ¼ë¡œ ë¶ˆë ¸ì„ ê²½ìš°, ê°™ì€ promiseë¥¼ ë°”ë¼ë³¼ ìˆ˜ ìˆë„ë¡ cacheì— ì‹¤í–‰í•œ suspender(.run())ë¥¼ ë‹´ì•„ì¤€ë‹¤.
    customPromise.cache = customPromise.run();
    throw customPromise.run(); // suspender
  } else if (customPromise.status === PROMISE_STATUS.FAIL) {
    throw customPromise.error;
  }

  if (customPromise.status === PROMISE_STATUS.PENDING) {
    // statusì˜ ì´ˆê¸° ìƒíƒœëŠ” nullì´ê³  ì´í›„ì— pendingìœ¼ë¡œ ë°”ë€ ë’¤, fulfilled í˜¹ì€ rejectedê°€ ëœë‹¤.
    // pendingì¼ ê²½ìš° suspenseì— ê°–íˆê²Œ ë  í…ë°, ì—¬ê¸°ì„œ ê°ì§€ë  ê²½ìš°ëŠ” suspenseì˜ ë™ì‘ì´ ì˜ëª»ëœ ê²ƒ
    if (customPromise.cache) {
      // ìºì‹œëœ ê°’ì´ ìˆì„ ê²½ìš° í•´ë‹¹ suspenderë¥¼ ë‹¤ì‹œ ë˜ì§€ê³  ì´ì™¸ì˜ ê²½ìš°ì—ëŠ” ì—ëŸ¬ë¡œ íŒë‹¨
      throw customPromise.cache;
      // throw customPromise.run();
    }
    throw new Error("Suspens Error");
  }

  return { data: customPromise.result };
}

export default useFetch;
```

### ê²°ë¡ 

react-queryê°€ ì•„ë‹Œ ë‹¤ë¥¸ ë¹„ë™ê¸° ë°ì´í„° íŒ¨ì¹­ ì‹œì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í›…ì„ ë§Œë“¤ì–´ë³´ë©°, Suspenseì˜ ê¸°ë³¸ ì›ë¦¬ì— ëŒ€í•´ì„œ ì´í•´í•  ìˆ˜ ìˆì—ˆë‹¤. 

**ErrorBoundaryê°€ throw í•œ Errorë¥¼ ê°ì§€í•˜ë“¯ SuspenseëŠ” throw í•œ Promiseë¥¼ ê°ì§€í•œë‹¤.** 

ë•Œë¬¸ì— ë°ì´í„° íŒ¨ì¹­ ì‹œì— Promiseì˜ ìƒíƒœì— ë”°ë¼ responseë¥¼ ë¦¬í„´í•˜ê±°ë‚˜ errorë¥¼ ë˜ì§€ê±°ë‚˜, pendingì¼ ê²½ìš° promiseë¥¼ ë˜ì§ˆ ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ì¶”ê°€í•œ ê²ƒ ë§Œìœ¼ë¡œ promiseë¥¼ suspenseì— ê°€ë‘˜ ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.

â†’ react-queryì˜ suspense ì˜µì…˜ê³¼ React.Suspenseë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë¬¸ì œê°€ ë˜ì§€ ì•Šì„ ê²ƒ ê°™ë‹¤.

ë˜í•œ SSRì„ ì§€ì›í•˜ê¸° ìœ„í•´ SSRSuspenderë¥¼ ë§Œë“¤ì—ˆëŠ”ë°, ì—¬ê¸°ì„œëŠ” mount ë˜ì§€ ì•Šì•˜ì„ ë•Œ fallbackì„ ë‚´ë ¤ì£¼ë„ë¡ í•˜ëŠ” ë¶€ë¶„ë§Œ ì¶”ê°€í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°œë°œí•  ìˆ˜ ìˆì—ˆë‹¤.
